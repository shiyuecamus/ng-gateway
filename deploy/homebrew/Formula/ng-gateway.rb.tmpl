class NgGateway < Formula
  desc "High-throughput IoT gateway (NG Gateway)"
  homepage "https://github.com/shiyuecamus/ng-gateway"
  license "Apache-2.0"

  # Release version (used in logs/service name only)
  version "{{VERSION}}"

  on_macos do
    on_arm do
      url "{{URL_ARM64}}"
      sha256 "{{SHA256_ARM64}}"
    end

    on_intel do
      url "{{URL_AMD64}}"
      sha256 "{{SHA256_AMD64}}"
    end
  end

  # Install layout notes:
  # - We keep a dedicated runtime directory under var/ so relative paths in the
  #   runtime artifacts (db/drivers/plugins/certs) work as-is.
  # - A wrapper script in bin/ `cd`s into the runtime dir before launching.
  def install
    # Packaging contract (Scheme A):
    # - The tarball MUST contain exactly one top-level directory.
    # - Homebrew MUST stage into that directory so buildpath contains:
    #   - gateway.toml
    #   - bin/ng-gateway-bin
    odie "Invalid tarball layout: missing gateway.toml or bin/ng-gateway-bin in buildpath" unless
      (buildpath/"gateway.toml").exist? && (buildpath/"bin/ng-gateway-bin").exist?

    libexec.install Dir["*"]

    runtime_dir = var/"lib/ng-gateway"
    runtime_dir.mkpath

    # Copy default config + bundled resources into runtime dir on first install.
    # Users can edit files under var/ without being overwritten by upgrades.
    (runtime_dir/"gateway.toml").write (libexec/"gateway.toml").read unless (runtime_dir/"gateway.toml").exist?

    # SQLite database is created automatically on first start (auto_create + migrations).
    # We only ensure the default data directory exists for the default config:
    # - data dir is `./data` (relative to runtime_dir)
    (runtime_dir/"data").mkpath

    # Always ensure builtin drivers/plugins exist under runtime dir (overwrite-safe by using rsync-like behavior).
    # We do a simple copy here; users' custom drivers/plugins live in ./drivers/custom and ./plugins/custom.
    (runtime_dir/"drivers/builtin").mkpath
    (runtime_dir/"plugins/builtin").mkpath
    cp_r (libexec/"drivers/builtin").children, (runtime_dir/"drivers/builtin"), remove_destination: true
    cp_r (libexec/"plugins/builtin").children, (runtime_dir/"plugins/builtin"), remove_destination: true

    # Ensure writable dirs exist
    (runtime_dir/"certs").mkpath
    (runtime_dir/"pki/own").mkpath
    (runtime_dir/"pki/private").mkpath

    # Wrapper entrypoint
    (bin/"ng-gateway").write <<~EOS
      #!/bin/bash
      set -euo pipefail
      cd "#{runtime_dir}"
      # Forward user-provided args (e.g. --help/--version) to the real binary.
      exec "#{libexec}/bin/ng-gateway-bin" --config "#{runtime_dir}/gateway.toml" "$@"
    EOS
    chmod 0755, bin/"ng-gateway"
  end

  service do
    run [opt_bin/"ng-gateway"]
    keep_alive true
    working_dir var/"lib/ng-gateway"
    log_path var/"log/ng-gateway.log"
    error_log_path var/"log/ng-gateway.error.log"
  end

  def caveats
    runtime_dir = var/"lib/ng-gateway"
    <<~EOS
      NG Gateway has been installed.

      Runtime directory (working directory):
        #{runtime_dir}

      Edit configuration:
        #{runtime_dir}/gateway.toml

      Runtime sub-directories (default layout):
        - data:    #{runtime_dir}/data
        - drivers: #{runtime_dir}/drivers
        - plugins: #{runtime_dir}/plugins
        - certs:   #{runtime_dir}/certs
        - pki:     #{runtime_dir}/pki

      Logs:
        - stdout: #{var}/log/ng-gateway.log
        - stderr: #{var}/log/ng-gateway.error.log

      Start/Stop/Status (recommended: run as a background service):
        brew services start ng-gateway
        brew services list
        brew services restart ng-gateway
        brew services stop ng-gateway

      Health checks:
        - HTTP:  curl -fsS http://127.0.0.1:8978/health   # -> OK
        - HTTPS: curl -kfsS https://127.0.0.1:8979/health # if enabled (self-signed: -k)

      Web access (defaults, if UI is enabled in gateway.toml):
        - UI:  http://127.0.0.1:8978/
        - API: http://127.0.0.1:8978/api

      Default UI credentials (initial):
        - username: system_admin
        - password: system_admin

      After editing gateway.toml, restart the service:
        brew services restart ng-gateway
    EOS
  end

  test do
    # Basic smoke test: binary should print help
    assert_match "NG Gateway", shell_output("#{opt_bin}/ng-gateway --help", 0)
  end
end

