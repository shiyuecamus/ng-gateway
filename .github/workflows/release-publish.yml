name: Release Publish Packaging

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  RELEASE_TAG: ${{ github.event.release.tag_name }}
  REPO: ${{ github.repository }}
  NFPM_VERSION: v2.44.1

jobs:
  build_ui_zip:
    name: Build UI dist zip
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # ng-gateway-ui is a git submodule; we must fetch it for pnpm build.
          submodules: recursive

      - name: Setup Node.js
        # NOTE: actions/setup-node "cache: pnpm" requires pnpm to be available
        # on PATH at *setup-node step time*. Install pnpm first, then enable caching.
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: ng-gateway-ui/pnpm-lock.yaml

      - name: Install UI dependencies
        working-directory: ng-gateway-ui
        run: pnpm install --frozen-lockfile

      - name: Build UI app
        working-directory: ng-gateway-ui
        run: pnpm run build --filter @vben/web-antd

      - name: Pack dist
        run: |
          set -euo pipefail
          dist_dir="ng-gateway-ui/apps/web-antd/dist"
          # Best practice:
          # - Keep the artifact payload as a *single file at the root* to make
          #   download/extract deterministic (no nested directories).
          # - Consumer jobs will download it into `ng-gateway-web/ui-dist.zip`,
          #   which matches the contract used by `ui-embedded` builds.
          out_zip="ui-dist.zip"

          test -d "${dist_dir}"

          # Create a zip that can be consumed by the Rust build (ui-embedded).
          # -X: eXclude extra file attributes for better reproducibility across runners.
          out_zip_abs="$(pwd)/${out_zip}"
          (cd "${dist_dir}" && zip -X -r -q "${out_zip_abs}" .)

          test -f "${out_zip}"
          echo "[ok] packed: ${out_zip}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ui-dist-zip
          path: ui-dist.zip
          if-no-files-found: error

  build_macos_homebrew:
    name: Build macOS Homebrew tarball (${{ matrix.arch }})
    needs: [build_ui_zip]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            arch: arm64
            target: aarch64-apple-darwin
          # Use an x86_64 runner to avoid cross-compiling krb5-src (configure cannot run tests).
          - runner: macos-15-intel
            arch: amd64
            target: x86_64-apple-darwin
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download UI artifact
        uses: actions/download-artifact@v4
        with:
          name: ui-dist-zip
          path: ng-gateway-web

      - name: Verify ui-dist.zip
        run: |
          set -euo pipefail
          test -f "ng-gateway-web/ui-dist.zip"
          echo "[ok] ui-dist.zip ready: $(pwd)/ng-gateway-web/ui-dist.zip"

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            .
          cache-on-failure: true

      - name: Install Protoc
        run: brew install protobuf cyrus-sasl pkg-config

      - name: Package tarball
        env:
          VERSION: ${{ env.RELEASE_TAG }}
          WITHOUT_UI: "1"
          # Cross-arch packaging support (also works for native arch).
          ARCH: ${{ matrix.arch }}
          TARGET_TRIPLE: ${{ matrix.target }}
        run: bash deploy/homebrew/scripts/package-tarball.sh

      - name: Upload tarball
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          tarball="deploy/homebrew/dist/ng-gateway-${RELEASE_TAG}-darwin-${{ matrix.arch }}.tar.gz"
          sha="${tarball}.sha256"
          test -f "${tarball}"
          test -f "${sha}"
          gh release upload "${RELEASE_TAG}" "${tarball}" "${sha}" --repo "${REPO}" --clobber

  generate_homebrew_formula:
    name: Generate Homebrew formula
    needs: [build_macos_homebrew]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download sha256
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p /tmp/ng-gateway-release-assets
          gh release download "${RELEASE_TAG}" \
            --repo "${REPO}" \
            --dir /tmp/ng-gateway-release-assets \
            --pattern "ng-gateway-${RELEASE_TAG}-darwin-arm64.tar.gz.sha256" \
            --pattern "ng-gateway-${RELEASE_TAG}-darwin-amd64.tar.gz.sha256"

      - name: Generate ng-gateway.rb
        env:
          VERSION: ${{ env.RELEASE_TAG }}
        run: |
          set -euo pipefail
          sha_arm64="$(cat "/tmp/ng-gateway-release-assets/ng-gateway-${RELEASE_TAG}-darwin-arm64.tar.gz.sha256")"
          sha_amd64="$(cat "/tmp/ng-gateway-release-assets/ng-gateway-${RELEASE_TAG}-darwin-amd64.tar.gz.sha256")"
          url_arm64="https://github.com/${REPO}/releases/download/${RELEASE_TAG}/ng-gateway-${RELEASE_TAG}-darwin-arm64.tar.gz"
          url_amd64="https://github.com/${REPO}/releases/download/${RELEASE_TAG}/ng-gateway-${RELEASE_TAG}-darwin-amd64.tar.gz"

          URL_ARM64="${url_arm64}" SHA256_ARM64="${sha_arm64}" \
          URL_AMD64="${url_amd64}" SHA256_AMD64="${sha_amd64}" \
          bash deploy/homebrew/scripts/generate-formula.sh

      - name: Upload formula
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          formula="deploy/homebrew/Formula/ng-gateway.rb"
          test -f "${formula}"
          gh release upload "${RELEASE_TAG}" "${formula}" --repo "${REPO}" --clobber

  update_homebrew_tap_repo:
    name: Update Homebrew tap repository
    needs: [generate_homebrew_formula]
    runs-on: ubuntu-latest
    steps:
      - name: Download formula
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p /tmp/ng-gateway-formula
          gh release download "${RELEASE_TAG}" \
            --repo "${REPO}" \
            --dir /tmp/ng-gateway-formula \
            --pattern "ng-gateway.rb"

      - name: Checkout tap repo
        uses: actions/checkout@v4
        with:
          repository: shiyuecamus/homebrew-ng-gateway
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Push Formula
        working-directory: tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail
          : "${HOMEBREW_TAP_TOKEN:?missing HOMEBREW_TAP_TOKEN}"
          git remote set-url origin "https://github.com/shiyuecamus/homebrew-ng-gateway.git"
          git config --local http.https://github.com/.extraheader \
            "AUTHORIZATION: basic $(printf 'x-access-token:%s' "${HOMEBREW_TAP_TOKEN}" | base64 -w0)"

          mkdir -p Formula
          cp -f "/tmp/ng-gateway-formula/ng-gateway.rb" "Formula/ng-gateway.rb"

          git add Formula/ng-gateway.rb
          if git diff --cached --quiet; then
            echo "[skip] no changes in formula"
            exit 0
          fi

          git -c user.name="ng-gateway-ci" -c user.email="ci@users.noreply.github.com" \
            commit -m "chore(homebrew): bump ng-gateway to ${RELEASE_TAG}"
          git push origin HEAD:main

  build_linux_deb:
    name: Build Linux .deb (${{ matrix.deb_arch }})
    needs: [build_ui_zip]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            deb_arch: amd64
          - target: aarch64-unknown-linux-gnu
            deb_arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download UI artifact
        uses: actions/download-artifact@v4
        with:
          name: ui-dist-zip
          path: ng-gateway-web

      - name: Verify ui-dist.zip
        run: |
          set -euo pipefail
          test -f "ng-gateway-web/ui-dist.zip"
          echo "[ok] ui-dist.zip ready: $(pwd)/ng-gateway-web/ui-dist.zip"

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            .
          cache-on-failure: true

      - name: Install Protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Install nfpm
        run: |
          set -euo pipefail
          go install github.com/goreleaser/nfpm/v2/cmd/nfpm@${NFPM_VERSION}
          echo "${HOME}/go/bin" >> "${GITHUB_PATH}"
          nfpm --version

      - name: Build .deb
        env:
          # e.g. v1.2.3
          RELEASE_TAG: ${{ env.RELEASE_TAG }}
          # e.g. 1.2.3
          PKG_VERSION: ${{ env.RELEASE_TAG }}
          TARGET_TRIPLE: ${{ matrix.target }}
          DEB_ARCH: ${{ matrix.deb_arch }}
          # Let xtask use cross for the actual build.
          XTASK_CARGO: cross
          # Do NOT export cross compiler vars globally (it breaks `go install nfpm` via cgo).
          # If any build script consults pkg-config in cross mode, allow it here (scoped).
          PKG_CONFIG_ALLOW_CROSS: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '1' || '' }}
        run: |
          set -euo pipefail
          PKG_VERSION="${PKG_VERSION#v}"
          export PKG_VERSION
          bash deploy/linux/scripts/package-deb.sh

      - name: Upload .deb
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          pkg_version="${RELEASE_TAG#v}"
          pkg="deploy/linux/dist/ng-gateway_${pkg_version}_${{ matrix.deb_arch }}.deb"
          test -f "${pkg}"
          gh release upload "${RELEASE_TAG}" "${pkg}" --repo "${REPO}" --clobber

  build_linux_rpm:
    name: Build Linux .rpm (${{ matrix.rpm_arch }})
    needs: [build_ui_zip]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            rpm_arch: x86_64
          - target: aarch64-unknown-linux-gnu
            rpm_arch: aarch64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download UI artifact
        uses: actions/download-artifact@v4
        with:
          name: ui-dist-zip
          path: ng-gateway-web

      - name: Verify ui-dist.zip
        run: |
          set -euo pipefail
          test -f "ng-gateway-web/ui-dist.zip"
          echo "[ok] ui-dist.zip ready: $(pwd)/ng-gateway-web/ui-dist.zip"

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            .
          cache-on-failure: true

      - name: Install Protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Install nfpm
        run: |
          set -euo pipefail
          go install github.com/goreleaser/nfpm/v2/cmd/nfpm@${NFPM_VERSION}
          echo "${HOME}/go/bin" >> "${GITHUB_PATH}"
          nfpm --version

      - name: Build .rpm
        env:
          RELEASE_TAG: ${{ env.RELEASE_TAG }}
          PKG_VERSION: ${{ env.RELEASE_TAG }}
          TARGET_TRIPLE: ${{ matrix.target }}
          RPM_ARCH: ${{ matrix.rpm_arch }}
          XTASK_CARGO: cross
          PKG_CONFIG_ALLOW_CROSS: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && '1' || '' }}
        run: |
          set -euo pipefail
          PKG_VERSION="${PKG_VERSION#v}"
          export PKG_VERSION
          bash deploy/linux/scripts/package-rpm.sh

      - name: Upload .rpm
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          pkg_version="${RELEASE_TAG#v}"
          pkg="deploy/linux/dist/ng-gateway-${pkg_version}-1.${{ matrix.rpm_arch }}.rpm"
          test -f "${pkg}"
          gh release upload "${RELEASE_TAG}" "${pkg}" --repo "${REPO}" --clobber

  docker_image_push_arch:
    name: Build & Push Docker image (${{ matrix.platform }})
    runs-on: ${{ matrix.runs_on }}
    timeout-minutes: 180
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          # Self-hosted runner (Ubuntu amd64 VM)
          - platform: linux/amd64
            arch_tag: amd64
            runs_on: [self-hosted, Linux, X64, ng-docker]
          # Self-hosted runner (Ubuntu arm64 VM)
          - platform: linux/arm64
            arch_tag: arm64
            runs_on: [self-hosted, Linux, ARM64, ng-docker]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Dockerfile builds UI from ng-gateway-ui (git submodule).
          submodules: recursive

      - name: Compute release version
        id: version
        run: |
          set -euo pipefail
          ver="${RELEASE_TAG#v}"
          echo "release_version=${ver}" >> "${GITHUB_OUTPUT}"

      - name: Detect proxy from runner / docker daemon
        run: |
          set -euo pipefail

          # Prefer runner process env; fall back to docker daemon proxy (from systemd drop-in).
          http_proxy="${HTTP_PROXY:-}"
          https_proxy="${HTTPS_PROXY:-}"
          no_proxy="${NO_PROXY:-}"

          if [[ -z "${http_proxy}" ]]; then
            http_proxy="$(docker info --format '{{.HTTPProxy}}' 2>/dev/null || true)"
          fi
          if [[ -z "${https_proxy}" ]]; then
            https_proxy="$(docker info --format '{{.HTTPSProxy}}' 2>/dev/null || true)"
          fi
          if [[ -z "${no_proxy}" ]]; then
            no_proxy="$(docker info --format '{{.NoProxy}}' 2>/dev/null || true)"
          fi

          # docker info prints "<nil>" when unset
          [[ "${http_proxy}" == "<nil>" ]] && http_proxy=""
          [[ "${https_proxy}" == "<nil>" ]] && https_proxy=""
          [[ "${no_proxy}" == "<nil>" ]] && no_proxy=""

          if [[ -n "${http_proxy}" ]]; then
            echo "HTTP_PROXY=${http_proxy}" >> "${GITHUB_ENV}"
            echo "http_proxy=${http_proxy}" >> "${GITHUB_ENV}"
          fi
          if [[ -n "${https_proxy}" ]]; then
            echo "HTTPS_PROXY=${https_proxy}" >> "${GITHUB_ENV}"
            echo "https_proxy=${https_proxy}" >> "${GITHUB_ENV}"
          fi
          if [[ -n "${no_proxy}" ]]; then
            echo "NO_PROXY=${no_proxy}" >> "${GITHUB_ENV}"
            echo "no_proxy=${no_proxy}" >> "${GITHUB_ENV}"
          fi

      - name: Set up Docker Buildx
        run: |
          set -euo pipefail
          # `push-by-digest` requires docker-container driver.
          # Avoid falling back to the default "docker" driver by forcing a fresh builder and explicitly using it.
          docker buildx rm -f ng-gateway-builder >/dev/null 2>&1 || true
          docker buildx create --name ng-gateway-builder --driver docker-container --use \
            --driver-opt "env.http_proxy=${HTTP_PROXY:-}" \
            --driver-opt "env.https_proxy=${HTTPS_PROXY:-}"
          docker buildx inspect ng-gateway-builder --bootstrap

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push
        run: |
          set -euo pipefail

          # Push by digest (no arch-specific tags).
          # This is the key to keeping Docker Hub clean: only the final multi-arch tags will exist.
          metadata_file="/tmp/ng-gateway-buildx-metadata-${{ matrix.arch_tag }}.json"

          build_arg_args=()
          [[ -n "${HTTP_PROXY:-}" ]] && build_arg_args+=(--build-arg "HTTP_PROXY=${HTTP_PROXY}")
          [[ -n "${HTTPS_PROXY:-}" ]] && build_arg_args+=(--build-arg "HTTPS_PROXY=${HTTPS_PROXY}")
          [[ -n "${NO_PROXY:-}" ]] && build_arg_args+=(--build-arg "NO_PROXY=${NO_PROXY}")

          docker buildx build \
            --builder ng-gateway-builder \
            --platform "${{ matrix.platform }}" \
            --file deploy/docker/gateway.Dockerfile \
            --push \
            --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.version=${{ steps.version.outputs.release_version }}" \
            --metadata-file "${metadata_file}" \
            --output "type=image,name=shiyuecamus/ng-gateway,push-by-digest=true,name-canonical=true,push=true" \
            "${build_arg_args[@]}" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            .

          # Extract `containerimage.digest` from buildx metadata without depending on python/jq.
          digest="$(grep -oE '"containerimage\.digest"\s*:\s*"[^"]+"' "${metadata_file}" | head -n1 | sed -E 's/.*"([^"]+)".*/\1/')"
          : "${digest:?missing containerimage.digest in ${metadata_file}}"

          echo "[ok] built digest=${digest}"
          printf '%s\n' "${digest}" > "digest-${{ matrix.arch_tag }}.txt"

      - name: Upload digest artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-digest-${{ matrix.arch_tag }}
          path: digest-${{ matrix.arch_tag }}.txt
          if-no-files-found: error

  docker_image_manifest:
    name: Publish multi-arch Docker tags
    needs: [docker_image_push_arch]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - name: Compute release version
        id: version
        run: |
          set -euo pipefail
          ver="${RELEASE_TAG#v}"
          echo "release_version=${ver}" >> "${GITHUB_OUTPUT}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Download digest artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: docker-digest-*
          merge-multiple: true

      - name: Create and push multi-arch tag (version)
        run: |
          set -euo pipefail
          ver="${{ steps.version.outputs.release_version }}"
          digest_amd64="$(cat digest-amd64.txt)"
          digest_arm64="$(cat digest-arm64.txt)"
          docker buildx imagetools create \
            -t "shiyuecamus/ng-gateway:${ver}" \
            "shiyuecamus/ng-gateway@${digest_amd64}" \
            "shiyuecamus/ng-gateway@${digest_arm64}"
          docker buildx imagetools inspect "shiyuecamus/ng-gateway:${ver}"

      - name: Create and push multi-arch tag (latest)
        if: ${{ github.event.release.prerelease == false }}
        run: |
          set -euo pipefail
          digest_amd64="$(cat digest-amd64.txt)"
          digest_arm64="$(cat digest-arm64.txt)"
          docker buildx imagetools create \
            -t "shiyuecamus/ng-gateway:latest" \
            "shiyuecamus/ng-gateway@${digest_amd64}" \
            "shiyuecamus/ng-gateway@${digest_arm64}"
          docker buildx imagetools inspect "shiyuecamus/ng-gateway:latest"

  helm_chart_push:
    name: Package & Push Helm chart
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute release version
        id: version
        run: |
          set -euo pipefail
          ver="${RELEASE_TAG#v}"
          echo "release_version=${ver}" >> "${GITHUB_OUTPUT}"

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Helm lint
        run: |
          set -euo pipefail
          helm lint deploy/helm/ng-gateway

      - name: Login to Docker Hub OCI registry
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -euo pipefail
          : "${DOCKERHUB_USERNAME:?missing DOCKERHUB_USERNAME}"
          : "${DOCKERHUB_TOKEN:?missing DOCKERHUB_TOKEN}"
          helm registry login registry-1.docker.io -u "${DOCKERHUB_USERNAME}" -p "${DOCKERHUB_TOKEN}"

      - name: Package chart
        run: |
          set -euo pipefail
          out_dir="/tmp/ng-gateway-charts"
          mkdir -p "${out_dir}"
          helm package deploy/helm/ng-gateway \
            --destination "${out_dir}" \
            --version "${{ steps.version.outputs.release_version }}" \
            --app-version "${{ steps.version.outputs.release_version }}"
          ls -lh "${out_dir}"

      - name: Push chart to Docker Hub (OCI)
        run: |
          set -euo pipefail
          chart="/tmp/ng-gateway-charts/ng-gateway-chart-${{ steps.version.outputs.release_version }}.tgz"
          test -f "${chart}"
          helm push "${chart}" oci://registry-1.docker.io/shiyuecamus
